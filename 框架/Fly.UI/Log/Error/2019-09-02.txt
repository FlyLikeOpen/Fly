
** [2019-09-02 15:47:54.630] - Begin **************************************************************
[LogID]: 7588fcc0-6085-4f69-bb00-0fee0947f132
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Net.Sockets.SocketException (0x80004005): 一个封锁操作被对 WSACancelBlockingCall 的调用中断。
   在 System.Net.Sockets.Socket.Accept()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 182
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 63
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 44
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 128
[ServerIP]: 192.168.0.160
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-09-02 15:47:54.599
[ProcessID]: 16772
[ProcessName]: w3wp
[ThreadID]: 7
[StackTrace]: 
** [2019-09-02 15:47:54.630] - End ****************************************************************

** [2019-09-02 16:14:24.863] - Begin **************************************************************
[LogID]: 46a5d336-8595-473b-a161-0f7076fb7044
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Net.Sockets.SocketException (0x80004005): 一个封锁操作被对 WSACancelBlockingCall 的调用中断。
   在 System.Net.Sockets.Socket.Accept()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 182
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 63
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 44
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 128
[ServerIP]: 192.168.0.160
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-09-02 16:14:24.840
[ProcessID]: 27572
[ProcessName]: w3wp
[ThreadID]: 7
[StackTrace]: 
** [2019-09-02 16:14:24.863] - End ****************************************************************

** [2019-09-02 17:01:55.375] - Begin **************************************************************
[LogID]: 3f3015fa-d7f8-45f1-a9bf-eee730b2e3d7
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Net.Sockets.SocketException (0x80004005): 一个封锁操作被对 WSACancelBlockingCall 的调用中断。
   在 System.Net.Sockets.Socket.Accept()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 182
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 63
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 44
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 128
[ServerIP]: 192.168.0.160
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-09-02 17:01:55.350
[ProcessID]: 15912
[ProcessName]: w3wp
[ThreadID]: 7
[StackTrace]: 
** [2019-09-02 17:01:55.375] - End ****************************************************************

** [2019-09-02 17:56:45.632] - Begin **************************************************************
[LogID]: d96c3022-d400-45dd-aa87-742fd66ac3e2
[Source]: WMSLocal
[Category]: Error
[RequestUrl]: http://local.wmslocal.com/so/ajaxautocreatewave/
[RequestReferer]: http://local.wmslocal.com/so/createwave/
[UserHostName]: 127.0.0.1
[UserHostAddress]: 127.0.0.1
[OperatorUser]: [Harry] harry
[Content]: System.NullReferenceException: 未将对象引用设置到对象的实例。
   在 IBB360.WMSLocal.APIImpls.Sales.WavePickingApi.InnerCreate(List`1 orders, WavePickingType wavePickingType) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Sales\WavePickingApi.cs:行号 1355
   在 IBB360.WMSLocal.APIImpls.Sales.WavePickingApi.AutoCreateWavePickingMixture(Guid merchantId, Int32 maxOrderQty, Int32 wavePickingQty) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Sales\WavePickingApi.cs:行号 179
   在 IBB360.WMSLocal.UI.Controllers.SOController.AjaxAutoCreateWave(Guid merchantId, Int32 maxOrderQty, Int32 wavePickingQty) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Controllers\SOController.cs:行号 22
   在 lambda_method(Closure , ControllerBase , Object[] )
   在 System.Web.Mvc.ReflectedActionDescriptor.Execute(ControllerContext controllerContext, IDictionary`2 parameters)
   在 System.Web.Mvc.ControllerActionInvoker.InvokeActionMethod(ControllerContext controllerContext, ActionDescriptor actionDescriptor, IDictionary`2 parameters)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.<BeginInvokeSynchronousActionMethod>b__39(IAsyncResult asyncResult, ActionInvocation innerInvokeState)
   在 System.Web.Mvc.Async.AsyncResultWrapper.WrappedAsyncResult`2.CallEndDelegate(IAsyncResult asyncResult)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.EndInvokeActionMethod(IAsyncResult asyncResult)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3d()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.EndInvokeActionMethodWithFilters(IAsyncResult asyncResult)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.<>c__DisplayClass21.<>c__DisplayClass2b.<BeginInvokeAction>b__1c()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.<>c__DisplayClass21.<BeginInvokeAction>b__1e(IAsyncResult asyncResult)
[ServerIP]: 127.0.0.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-09-02 17:56:45.573
[ProcessID]: 23424
[ProcessName]: w3wp
[ThreadID]: 23
[StackTrace]: 
** [2019-09-02 17:56:45.632] - End ****************************************************************

** [2019-09-02 17:57:23.792] - Begin **************************************************************
[LogID]: 4315f368-122c-42e8-93ab-5d2d8e7e886c
[Source]: WMSLocal
[Category]: Error
[RequestUrl]: http://local.wmslocal.com/so/ajaxautocreatewave/
[RequestReferer]: http://local.wmslocal.com/so/createwave/
[UserHostName]: 127.0.0.1
[UserHostAddress]: 127.0.0.1
[OperatorUser]: [Harry] harry
[Content]: System.NullReferenceException: 未将对象引用设置到对象的实例。
   在 IBB360.WMSLocal.APIImpls.Sales.WavePickingApi.InnerCreate(List`1 orders, WavePickingType wavePickingType) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Sales\WavePickingApi.cs:行号 1355
   在 IBB360.WMSLocal.APIImpls.Sales.WavePickingApi.AutoCreateWavePickingMixture(Guid merchantId, Int32 maxOrderQty, Int32 wavePickingQty) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Sales\WavePickingApi.cs:行号 179
   在 IBB360.WMSLocal.UI.Controllers.SOController.AjaxAutoCreateWave(Guid merchantId, Int32 maxOrderQty, Int32 wavePickingQty) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Controllers\SOController.cs:行号 22
   在 lambda_method(Closure , ControllerBase , Object[] )
   在 System.Web.Mvc.ReflectedActionDescriptor.Execute(ControllerContext controllerContext, IDictionary`2 parameters)
   在 System.Web.Mvc.ControllerActionInvoker.InvokeActionMethod(ControllerContext controllerContext, ActionDescriptor actionDescriptor, IDictionary`2 parameters)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.<BeginInvokeSynchronousActionMethod>b__39(IAsyncResult asyncResult, ActionInvocation innerInvokeState)
   在 System.Web.Mvc.Async.AsyncResultWrapper.WrappedAsyncResult`2.CallEndDelegate(IAsyncResult asyncResult)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.EndInvokeActionMethod(IAsyncResult asyncResult)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3d()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.EndInvokeActionMethodWithFilters(IAsyncResult asyncResult)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.<>c__DisplayClass21.<>c__DisplayClass2b.<BeginInvokeAction>b__1c()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.<>c__DisplayClass21.<BeginInvokeAction>b__1e(IAsyncResult asyncResult)
[ServerIP]: 127.0.0.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-09-02 17:57:23.786
[ProcessID]: 23424
[ProcessName]: w3wp
[ThreadID]: 19
[StackTrace]: 
** [2019-09-02 17:57:23.792] - End ****************************************************************

** [2019-09-02 17:58:30.426] - Begin **************************************************************
[LogID]: 901370cd-029c-424c-ac25-b9de0c5da5a4
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Net.Sockets.SocketException (0x80004005): 一个封锁操作被对 WSACancelBlockingCall 的调用中断。
   在 System.Net.Sockets.Socket.Accept()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 182
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 63
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 44
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 128
[ServerIP]: 127.0.0.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-09-02 17:58:30.390
[ProcessID]: 23424
[ProcessName]: w3wp
[ThreadID]: 7
[StackTrace]: 
** [2019-09-02 17:58:30.426] - End ****************************************************************

** [2019-09-02 17:58:30.999] - Begin **************************************************************
[LogID]: 24872e5e-0c41-4219-8f0c-4037bf342a55
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 正在中止线程。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Threading.ThreadAbortException: 正在中止线程。
   在 SNIReadSyncOverAsync(SNI_ConnWrapper* , SNI_Packet** , Int32 )
   在 SNINativeMethodWrapper.SNIReadSyncOverAsync(SafeHandle pConn, IntPtr& packet, Int32 timeout)
   在 System.Data.SqlClient.TdsParserStateObject.ReadSniSyncOverAsync()
   在 System.Data.SqlClient.TdsParserStateObject.TryReadNetworkPacket()
   在 System.Data.SqlClient.TdsParserStateObject.TryPrepareBuffer()
   在 System.Data.SqlClient.TdsParserStateObject.TryReadByte(Byte& value)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 137
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 143
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 67
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 82
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 72
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\StaffUserApi.cs:行号 1263
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 92
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 90
[ServerIP]: 127.0.0.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-09-02 17:58:30.822
[ProcessID]: 23424
[ProcessName]: w3wp
[ThreadID]: 9
[StackTrace]: 
** [2019-09-02 17:58:30.999] - End ****************************************************************

** [2019-09-02 17:58:31.174] - Begin **************************************************************
[LogID]: 8cd872bd-8910-4833-8071-35b701e9da36
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常[外围异常]：

System.Threading.ThreadAbortException: 正在中止线程。
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 91
[ServerIP]: 127.0.0.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-09-02 17:58:31.019
[ProcessID]: 23424
[ProcessName]: w3wp
[ThreadID]: 9
[StackTrace]: 
** [2019-09-02 17:58:31.174] - End ****************************************************************

** [2019-09-02 18:14:35.787] - Begin **************************************************************
[LogID]: 141f9232-beda-45d6-a744-b28481a5ea24
[Source]: WMSLocal
[Category]: Error
[RequestUrl]: http://local.wmslocal.com/so/ajaxautocreatewave/
[RequestReferer]: http://local.wmslocal.com/so/createwave/
[UserHostName]: 127.0.0.1
[UserHostAddress]: 127.0.0.1
[OperatorUser]: [Harry] harry
[Content]: System.NullReferenceException: 未将对象引用设置到对象的实例。
   在 IBB360.WMSLocal.APIImpls.Sales.WavePickingApi.InnerCreate(List`1 orders, WavePickingType wavePickingType) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Sales\WavePickingApi.cs:行号 1353
   在 IBB360.WMSLocal.APIImpls.Sales.WavePickingApi.AutoCreateWavePickingMixture(Guid merchantId, Int32 maxOrderQty, Int32 wavePickingQty) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Sales\WavePickingApi.cs:行号 177
   在 IBB360.WMSLocal.UI.Controllers.SOController.AjaxAutoCreateWave(Guid merchantId, Int32 maxOrderQty, Int32 wavePickingQty) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Controllers\SOController.cs:行号 22
   在 lambda_method(Closure , ControllerBase , Object[] )
   在 System.Web.Mvc.ReflectedActionDescriptor.Execute(ControllerContext controllerContext, IDictionary`2 parameters)
   在 System.Web.Mvc.ControllerActionInvoker.InvokeActionMethod(ControllerContext controllerContext, ActionDescriptor actionDescriptor, IDictionary`2 parameters)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.<BeginInvokeSynchronousActionMethod>b__39(IAsyncResult asyncResult, ActionInvocation innerInvokeState)
   在 System.Web.Mvc.Async.AsyncResultWrapper.WrappedAsyncResult`2.CallEndDelegate(IAsyncResult asyncResult)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.EndInvokeActionMethod(IAsyncResult asyncResult)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3d()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.AsyncInvocationWithFilters.<>c__DisplayClass46.<InvokeActionMethodFilterAsynchronouslyRecursive>b__3f()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.EndInvokeActionMethodWithFilters(IAsyncResult asyncResult)
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.<>c__DisplayClass21.<>c__DisplayClass2b.<BeginInvokeAction>b__1c()
   在 System.Web.Mvc.Async.AsyncControllerActionInvoker.<>c__DisplayClass21.<BeginInvokeAction>b__1e(IAsyncResult asyncResult)
[ServerIP]: 192.168.0.160
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-09-02 18:14:35.735
[ProcessID]: 23424
[ProcessName]: w3wp
[ThreadID]: 24
[StackTrace]: 
** [2019-09-02 18:14:35.787] - End ****************************************************************

** [2019-09-02 18:19:06.118] - Begin **************************************************************
[LogID]: ab7b79ac-f481-4655-8637-70962a746ce7
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Net.Sockets.SocketException (0x80004005): 一个封锁操作被对 WSACancelBlockingCall 的调用中断。
   在 System.Net.Sockets.Socket.Accept()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 182
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 63
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 44
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 128
[ServerIP]: 192.168.0.160
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-09-02 18:19:06.109
[ProcessID]: 23424
[ProcessName]: w3wp
[ThreadID]: 8
[StackTrace]: 
** [2019-09-02 18:19:06.118] - End ****************************************************************

** [2019-09-02 18:45:39.648] - Begin **************************************************************
[LogID]: 9740c489-292d-48ff-a4dd-13eb55ccf44e
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Net.Sockets.SocketException (0x80004005): 一个封锁操作被对 WSACancelBlockingCall 的调用中断。
   在 System.Net.Sockets.Socket.Accept()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 182
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 63
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 44
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 128
[ServerIP]: 192.168.0.160
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-09-02 18:45:39.617
[ProcessID]: 23424
[ProcessName]: w3wp
[ThreadID]: 24
[StackTrace]: 
** [2019-09-02 18:45:39.648] - End ****************************************************************
