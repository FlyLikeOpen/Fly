
** [2019-12-12 10:40:03.294] - Begin **************************************************************
[LogID]: 6f22443e-f1a7-480a-a284-b22ac4c72397
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Net.Sockets.SocketException (0x80004005): 一个封锁操作被对 WSACancelBlockingCall 的调用中断。
   在 System.Net.Sockets.Socket.Accept()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 182
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 63
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 44
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 128
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 10:40:03.270
[ProcessID]: 18328
[ProcessName]: w3wp
[ThreadID]: 7
[StackTrace]: 
** [2019-12-12 10:40:03.294] - End ****************************************************************

** [2019-12-12 15:26:02.866] - Begin **************************************************************
[LogID]: 26c76e8a-b96c-4053-be2d-48dad29dfb28
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Net.Sockets.SocketException (0x80004005): 一个封锁操作被对 WSACancelBlockingCall 的调用中断。
   在 System.Net.Sockets.Socket.Accept()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 182
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 63
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 44
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0()
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:26:02.831
[ProcessID]: 32632
[ProcessName]: w3wp
[ThreadID]: 9
[StackTrace]: 
** [2019-12-12 15:26:02.866] - End ****************************************************************

** [2019-12-12 15:30:37.284] - Begin **************************************************************
[LogID]: 2c578e56-7e15-450f-be2b-bc212a974b12
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Net.Sockets.SocketException (0x80004005): 一个封锁操作被对 WSACancelBlockingCall 的调用中断。
   在 System.Net.Sockets.Socket.Accept()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 182
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 63
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 44
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 128
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:30:37.241
[ProcessID]: 32632
[ProcessName]: w3wp
[ThreadID]: 9
[StackTrace]: 
** [2019-12-12 15:30:37.284] - End ****************************************************************

** [2019-12-12 15:30:37.843] - Begin **************************************************************
[LogID]: b025e3c3-3c63-46c3-b0c1-1b4e85869bcb
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

System.Threading.ThreadAbortException: 正在中止线程。
   在 System.Net.UnsafeNclNativeMethods.OSSOCK.recv(IntPtr socketHandle, Byte* pinnedBuffer, Int32 len, SocketFlags socketFlags)
   在 System.Net.Sockets.Socket.Receive(Byte[] buffer, Int32 offset, Int32 size, SocketFlags socketFlags, SocketError& errorCode)
   在 System.Net.Sockets.NetworkStream.Read(Byte[] buffer, Int32 offset, Int32 size)
   在 System.Net.PooledStream.Read(Byte[] buffer, Int32 offset, Int32 size)
   在 System.Net.Connection.SyncRead(HttpWebRequest request, Boolean userRetrievedStream, Boolean probeRead)
   在 System.Net.ConnectStream.ProcessWriteCallDone(ConnectionReturnResult returnResult)
   在 System.Net.ConnectStream.CallDone(ConnectionReturnResult returnResult)
   在 System.Net.ConnectStream.CloseInternal(Boolean internalCall, Boolean aborting)
   在 System.Net.ConnectStream.System.Net.ICloseEx.CloseEx(CloseExState closeState)
   在 System.Net.HttpWebRequest.EndWriteHeaders_Part2()
   在 System.Net.HttpWebRequest.EndWriteHeaders(Boolean async)
   在 System.Net.HttpWebRequest.WriteHeadersCallback(WebExceptionStatus errorStatus, ConnectStream stream, Boolean async)
   在 System.Net.ConnectStream.WriteHeaders(Boolean async)
   在 System.Net.HttpWebRequest.EndSubmitRequest()
   在 System.Net.Connection.SubmitRequest(HttpWebRequest request, Boolean forcedsubmit)
   在 System.Net.ServicePoint.SubmitRequest(HttpWebRequest request, String connName)
   在 System.Net.HttpWebRequest.SubmitRequest(ServicePoint servicePoint)
   在 System.Net.HttpWebRequest.GetResponse()
   在 IBB360.Framework.Common.HelperUtility.HttpGet(String url, Encoding encoding, String contentType, String userAgent, String host, String referer, IDictionary`2 customHeaders) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\HelperUtility.cs:行号 703
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\StaffUserApi.cs:行号 947
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 92
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 90
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:30:37.700
[ProcessID]: 32632
[ProcessName]: w3wp
[ThreadID]: 19
[StackTrace]: 
** [2019-12-12 15:30:37.843] - End ****************************************************************

** [2019-12-12 15:30:38.038] - Begin **************************************************************
[LogID]: eb9ec90b-3484-44ab-a467-aaf99aca7feb
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常[外围异常]：

System.Threading.ThreadAbortException: 正在中止线程。
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 91
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:30:37.854
[ProcessID]: 32632
[ProcessName]: w3wp
[ThreadID]: 19
[StackTrace]: 
** [2019-12-12 15:30:38.038] - End ****************************************************************

** [2019-12-12 15:36:16.925] - Begin **************************************************************
[LogID]: 1b81ecbe-15a3-4d1b-8807-adc383a75f8a
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Net.Sockets.SocketException (0x80004005): 通常每个套接字地址(协议/网络地址/端口)只允许使用一次。
   在 System.Net.Sockets.Socket.DoBind(EndPoint endPointSnapshot, SocketAddress socketAddress)
   在 System.Net.Sockets.Socket.Bind(EndPoint localEP)
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 175
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 63
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 44
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 128
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:36:16.813
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 21
[StackTrace]: 
** [2019-12-12 15:36:16.925] - End ****************************************************************

** [2019-12-12 15:37:55.483] - Begin **************************************************************
[LogID]: 053b10cf-4280-4c5b-acfd-2f5018178cbe
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffRolePermission”。不能在对象“dbo.StaffRolePermission”中插入重复键。重复键值为 (8ede3150-9058-4dba-9fed-0e35bc0f90b0, WMSLocal_InStockCount)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffRolePermission”。不能在对象“dbo.StaffRolePermission”中插入重复键。重复键值为 (8ede3150-9058-4dba-9fed-0e35bc0f90b0, WMSLocal_InStockCount)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 137
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 143
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 67
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 82
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 72
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\StaffUserApi.cs:行号 1263
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 92
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 90
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:37:55.468
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 35
[StackTrace]: 
** [2019-12-12 15:37:55.483] - End ****************************************************************

** [2019-12-12 15:37:55.524] - Begin **************************************************************
[LogID]: 9d6f4707-a57b-46b8-ba76-5f336a3944b8
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter)
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl)
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state)
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s)
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:37:55.480
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 25
[StackTrace]: 
** [2019-12-12 15:37:55.524] - End ****************************************************************

** [2019-12-12 15:37:55.559] - Begin **************************************************************
[LogID]: 57ce2ac8-156b-426a-8c2a-b5a8f03d502c
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 137
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 143
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 67
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 82
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 72
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\StaffUserApi.cs:行号 1263
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 92
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 90
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:37:55.553
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 42
[StackTrace]: 
** [2019-12-12 15:37:55.559] - End ****************************************************************

** [2019-12-12 15:37:55.646] - Begin **************************************************************
[LogID]: 999e3e46-0d0b-4bfe-82ec-f97cc56e1bdd
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter)
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl)
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state)
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s)
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:37:55.641
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 34
[StackTrace]: 
** [2019-12-12 15:37:55.646] - End ****************************************************************

** [2019-12-12 15:37:55.678] - Begin **************************************************************
[LogID]: c139a64e-0299-4a53-9ea9-2240a912c297
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter)
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl)
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state)
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s)
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:37:55.672
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 36
[StackTrace]: 
** [2019-12-12 15:37:55.678] - End ****************************************************************

** [2019-12-12 15:37:55.680] - Begin **************************************************************
[LogID]: 8f5b0ee5-3b72-4550-815b-4ef9e45b0e3a
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 137
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 143
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 67
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 82
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 72
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\StaffUserApi.cs:行号 1263
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 92
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 90
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:37:55.673
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 47
[StackTrace]: 
** [2019-12-12 15:37:55.680] - End ****************************************************************

** [2019-12-12 15:37:55.708] - Begin **************************************************************
[LogID]: cfa6a7ad-41b6-4013-bf0c-8239f443d642
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 137
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 143
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 67
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 82
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 72
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\StaffUserApi.cs:行号 1263
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 92
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 90
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:37:55.701
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 53
[StackTrace]: 
** [2019-12-12 15:37:55.708] - End ****************************************************************

** [2019-12-12 15:37:55.850] - Begin **************************************************************
[LogID]: cbb3381e-2a63-47cf-aa46-313385c95a59
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter)
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl)
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state)
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s)
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:37:55.845
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 29
[StackTrace]: 
** [2019-12-12 15:37:55.850] - End ****************************************************************
位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 72
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\StaffUserApi.cs:行号 1263
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 92
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 90
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:37:55.845
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 52
[StackTrace]: 
** [2019-12-12 15:37:55.850] - End ****************************************************************

** [2019-12-12 15:39:01.412] - Begin **************************************************************
[LogID]: ea2b39b4-4030-4aac-8494-821f18a52b66
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffUserInRole”。不能在对象“dbo.StaffUserInRole”中插入重复键。重复键值为 (905ed2a3-7d93-4ca8-ae33-81553b9d4efe, 98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffUserInRole”。不能在对象“dbo.StaffUserInRole”中插入重复键。重复键值为 (905ed2a3-7d93-4ca8-ae33-81553b9d4efe, 98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter)
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl)
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state)
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s)
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:39:01.378
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 49
[StackTrace]: 
** [2019-12-12 15:39:01.412] - End ****************************************************************

** [2019-12-12 15:39:01.436] - Begin **************************************************************
[LogID]: fa835bf4-9c7c-463f-ae8f-7abee2144be1
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffUserInRole”。不能在对象“dbo.StaffUserInRole”中插入重复键。重复键值为 (905ed2a3-7d93-4ca8-ae33-81553b9d4efe, 98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffUserInRole”。不能在对象“dbo.StaffUserInRole”中插入重复键。重复键值为 (905ed2a3-7d93-4ca8-ae33-81553b9d4efe, 98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 137
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 143
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 67
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 82
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 72
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\StaffUserApi.cs:行号 1263
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 92
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 90
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:39:01.394
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 29
[StackTrace]: 
** [2019-12-12 15:39:01.436] - End ****************************************************************

** [2019-12-12 15:39:02.522] - Begin **************************************************************
[LogID]: 553e790a-03a2-470a-a2bb-641faacf22e9
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffUserInRole”。不能在对象“dbo.StaffUserInRole”中插入重复键。重复键值为 (905ed2a3-7d93-4ca8-ae33-81553b9d4efe, 98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffUserInRole”。不能在对象“dbo.StaffUserInRole”中插入重复键。重复键值为 (905ed2a3-7d93-4ca8-ae33-81553b9d4efe, 98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter)
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl)
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state)
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s)
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:39:02.516
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 50
[StackTrace]: 
** [2019-12-12 15:39:02.522] - End ****************************************************************
位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 72
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\StaffUserApi.cs:行号 1263
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 92
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 90
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:39:02.516
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 35
[StackTrace]: 
** [2019-12-12 15:39:02.522] - End ****************************************************************

** [2019-12-12 15:39:03.671] - Begin **************************************************************
[LogID]: cb320757-974a-4e5e-a0fa-e762a3076018
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffUserInRole”。不能在对象“dbo.StaffUserInRole”中插入重复键。重复键值为 (905ed2a3-7d93-4ca8-ae33-81553b9d4efe, 98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffUserInRole”。不能在对象“dbo.StaffUserInRole”中插入重复键。重复键值为 (905ed2a3-7d93-4ca8-ae33-81553b9d4efe, 98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter)
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl)
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state)
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s)
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:39:03.664
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 16
[StackTrace]: 
** [2019-12-12 15:39:03.671] - End ****************************************************************

** [2019-12-12 15:39:04.879] - Begin **************************************************************
[LogID]: bbed4911-6b69-4d49-9b61-bd8ea19b7d52
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter)
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl)
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state)
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s)
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:39:04.874
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 24
[StackTrace]: 
** [2019-12-12 15:39:04.879] - End ****************************************************************

** [2019-12-12 15:39:06.429] - Begin **************************************************************
[LogID]: 7b7a0a8c-3f61-4986-afb6-aa2d37ed97d3
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 137
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteBySpecifiedConnStrKey.cs:行号 143
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 67
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 82
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.SqlDbAccess\SqlHelper_ExecuteByDefaultConnStrKey.cs:行号 72
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\StaffUserApi.cs:行号 1263
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 92
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s) 位置 D:\公司源码\trunk\ibb360\src\new\IBB360.Framework\IBB360.Framework.Common\AsynQueue\TimerJob.cs:行号 90
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:39:06.419
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 42
[StackTrace]: 
** [2019-12-12 15:39:06.429] - End ****************************************************************

** [2019-12-12 15:39:07.586] - Begin **************************************************************
[LogID]: 2affc9ce-616f-42dd-9d0a-ad0712933381
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: JobId为UpdateAllAdminUserDataFromERP的TimerJob执行发生程序异常：

IBB360.Framework.SqlDbAccess.DaoSqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
<<Connection String>> : Data Source=localhost;Initial Catalog=WMSLocal.Queue;Integrated Security=False;Persist Security Info=False;User ID=sa;Password=123; Max Pool Size=4096; Min Pool Size=10
<<SQL Script>> : 
DECLARE @changedCount INT
SET @changedCount=0
BEGIN TRY
	BEGIN TRAN
	--- 1. 更新User数据
	------ User数据永远不会做物理删除的，所以不用考虑Delete问题
	UPDATE
		a
	SET
		a.[LoginId]=b.[LoginId]
		,a.[Password]=b.[Password]
		,a.[PasswordSalt]=b.[PasswordSalt]
		,a.[DisplayName]=b.[DisplayName]
		,a.[Email]=b.[Email]
		,a.[Mobile]=b.[Mobile]
		,a.[Status]=b.[Status]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUser] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[LoginId]<>b.[LoginId]
		OR a.[Password]<>b.[Password]
		OR a.[PasswordSalt]<>b.[PasswordSalt]
		OR a.[DisplayName]<>b.[DisplayName]
		OR a.[Email]<>b.[Email]
		OR a.[Mobile]<>b.[Mobile]
		OR a.[Status]<>b.[Status]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUser]
	(
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], [Status], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [LoginId], [Password], [PasswordSalt], [DisplayName], [Email],
		[Mobile], 1 AS [Status], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_User] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffUser] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 2. 更新Role数据
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffRole]
	WHERE
		[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Log].[dbo].[Sync_Role] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[Name]=b.[Name]
		,a.[Description]=b.[Description]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffRole] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
			ON a.[Id]=b.[Id]
	WHERE
		a.[Name]<>b.[Name]
		OR a.[Description]<>b.[Description]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRole]
	(
		[Id], [Name], [Description], [CreatedOn], [CreatedBy]
	)
	SELECT
		[Id], [Name], [Description], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_Role] AS b WITH(NOLOCK)
	WHERE
		b.[Id] NOT IN (SELECT [Id] FROM [WMSLocal.Base].[dbo].[StaffRole] WITH(NOLOCK))
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 3. 更新RolePermission
	DELETE
	    b 
    FROM
		[WMSLocal.Base].[dbo].[StaffRolePermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
			WHERE
				a.[RoleId]=b.[RoleId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffRolePermission]
	(
		[RoleId], [PermissionKey], [CreatedOn], [CreatedBy]
	)
	SELECT
		a.[RoleId], a.[PermissionKey], GETDATE() AS [CreatedOn], '00000000-0000-0000-0000-000000000000' AS [CreatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_RolePermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffRolePermission] AS b WITH(NOLOCK)
			WHERE
				b.[RoleId]=a.[RoleId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 4. 更新UserInRole
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserInRole] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[RoleId]=b.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserInRole]
	(
		[UserId], [RoleId]
	)
	SELECT
		a.[UserId], a.[RoleId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserInRole] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserInRole] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[RoleId]=a.[RoleId]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 5. 更新UserTempPermission
	DELETE
        b
    FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
			WHERE
				a.[UserId]=b.[UserId]
				AND a.[PermissionKey]=b.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[FromTime]=b.[FromTime]
		,a.[ToTime]=b.[ToTime]
		,a.[UpdatedOn]=GETDATE()
		,a.[UpdatedBy]='00000000-0000-0000-0000-000000000000'
	FROM
		[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
			AND a.[PermissionKey]=b.[PermissionKey]
	WHERE
		a.[FromTime]<>b.[FromTime]
		OR a.[ToTime]<>b.[ToTime]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserTempPermission]
	(
		[UserId], [PermissionKey], [FromTime], [ToTime], [UpdatedOn], [UpdatedBy]
	)
	SELECT
		a.[UserId], a.[PermissionKey], a.[FromTime], a.[ToTime], GETDATE() AS [UpdatedOn], '00000000-0000-0000-0000-000000000000' AS [UpdatedBy]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserTempPermission] AS a WITH(NOLOCK)
	WHERE
		NOT EXISTS
		(
			SELECT TOP 1
				1
			FROM
				[WMSLocal.Base].[dbo].[StaffUserTempPermission] AS b WITH(NOLOCK)
			WHERE
				b.[UserId]=a.[UserId]
				AND b.[PermissionKey]=a.[PermissionKey]
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	--- 6. 更新UserWorkWeChat
	DELETE FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	WHERE
		[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT

	UPDATE
		a
	SET
		a.[WorkWeChatUserId]=b.[WorkWeChatUserId]
	FROM
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS a WITH(NOLOCK)
	INNER JOIN
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS b WITH(NOLOCK)
			ON a.[UserId]=b.[UserId]
	WHERE
		a.[WorkWeChatUserId]<>b.[WorkWeChatUserId]
	SET @changedCount=@changedCount+@@ROWCOUNT

	INSERT INTO
		[WMSLocal.Base].[dbo].[StaffUserWorkWeChat]
	(
		[UserId], [WorkWeChatUserId]
	)
	SELECT
		a.[UserId], a.[WorkWeChatUserId]
	FROM
		[WMSLocal.Log].[dbo].[Sync_UserWorkWeChat] AS a WITH(NOLOCK)
	WHERE
		a.[UserId] NOT IN
		(
			SELECT
				[UserId]
			FROM
				[WMSLocal.Base].[dbo].[StaffUserWorkWeChat] AS b WITH(NOLOCK)
		)
	SET @changedCount=@changedCount+@@ROWCOUNT
	COMMIT TRAN
	SELECT TOP 1 @changedCount AS [ChangedCount]
END TRY
BEGIN CATCH
	ROLLBACK TRAN
	DECLARE @ErrorMessage NVARCHAR(MAX)
	DECLARE @ErrorSeverity INT
	DECLARE @ErrorState INT
	SELECT
		@ErrorMessage = ERROR_MESSAGE()
		,@ErrorSeverity = ERROR_SEVERITY()
		,@ErrorState = ERROR_STATE()
	RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
END CATCH
 ---> System.Data.SqlClient.SqlException: 违反了 PRIMARY KEY 约束“PK_StaffRole”。不能在对象“dbo.StaffRole”中插入重复键。重复键值为 (98943f40-8756-4a2f-9587-89a17493cb54)。
   在 System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   在 System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   在 System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   在 System.Data.SqlClient.SqlDataReader.TryConsumeMetaData()
   在 System.Data.SqlClient.SqlDataReader.get_MetaData()
   在 System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString, Boolean isInternal, Boolean forDescribeParameterEncryption, Boolean shouldCacheForAlwaysEncrypted)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async, Int32 timeout, Task& task, Boolean asyncWrite, Boolean inRetry, SqlDataReader ds, Boolean describeParameterEncryptionRequest)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, TaskCompletionSource`1 completion, Int32 timeout, Task& task, Boolean& usedCache, Boolean asyncWrite, Boolean inRetry)
   在 System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method)
   在 System.Data.SqlClient.SqlCommand.ExecuteScalar()
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   --- 内部异常堆栈跟踪的结尾 ---
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(String connStrKey, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, CommandType cmdType, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar(DbInstance instance, String cmdText, Object parameter)
   在 IBB360.Framework.SqlDbAccess.SqlHelper.ExecuteScalar[TResult](DbInstance instance, String cmdText, Object parameter)
   在 IBB360.WMSLocal.APIImpls.Common.StaffUserApi.UpdateAllAdminUserDataFromERP(String appId, String serviceUrl)
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass6_0.<RegisterJobs>b__2(Object state)
   在 IBB360.Framework.Common.TimerJob.<>c__DisplayClass1_0.<RegisterJob>b__0(Object s)
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:39:07.579
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 19
[StackTrace]: 
** [2019-12-12 15:39:07.586] - End ****************************************************************

** [2019-12-12 15:39:12.431] - Begin **************************************************************
[LogID]: 63b12726-43df-4a3e-ac3d-95192738c165
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Threading.ThreadAbortException: 正在中止线程。
   在 System.Net.UnsafeNclNativeMethods.SafeNetHandles.accept(IntPtr socketHandle, Byte[] socketAddress, Int32& socketAddressSize)
   在 System.Net.SafeCloseSocket.InnerSafeCloseSocket.Accept(SafeCloseSocket socketHandle, Byte[] socketAddress, Int32& socketAddressSize)
   在 System.Net.Sockets.Socket.Accept()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort)
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0()
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 15:39:12.218
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 6
[StackTrace]: 
** [2019-12-12 15:39:12.431] - End ****************************************************************

** [2019-12-12 16:09:29.971] - Begin **************************************************************
[LogID]: 94cee405-5834-4c99-82f5-2ff8a5fb2ffb
[Source]: WMSLocal
[Category]: Error
[OperatorUser]: 00000000-0000-0000-0000-000000000000
[Content]: System.Net.Sockets.SocketException (0x80004005): 一个封锁操作被对 WSACancelBlockingCall 的调用中断。
   在 System.Net.Sockets.Socket.Accept()
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServer.StartServer() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 182
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 63
   在 IBB360.WMSLocal.APIImpls.Common.WebSocketServerManager.Start(Int32 serverPort) 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.APIImpls\Common\WebSocketServerManager.cs:行号 44
   在 IBB360.WMSLocal.UI.Global.<>c__DisplayClass8_0.<StartSocketServer>b__0() 位置 D:\公司源码\trunk\ibb360\source_code\IBB360.WMSLocal\IBB360.WMSLocal.UI\Global.asax.cs:行号 128
[ServerIP]: 192.168.137.1
[ServerName]: DESKTOP-03QPLOV
[ServerTime]: 2019-12-12 16:09:29.947
[ProcessID]: 30836
[ProcessName]: w3wp
[ThreadID]: 52
[StackTrace]: 
** [2019-12-12 16:09:29.971] - End ****************************************************************
